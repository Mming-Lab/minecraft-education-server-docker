services:
  # ================================================
  # ワールド1（デフォルト）
  # ================================================
  minecraft-edu-world1:
    image: ghcr.io/mming-lab/minecraft-education-server-docker:latest
    build: .
    container_name: minecraft-edu-world1
    hostname: mcedu-world1
    ports:
      - "${SERVER_PORT_WORLD_1}:${SERVER_PORT_WORLD_1}/udp"
    environment:
      SERVER_PUBLIC_IP: ${SERVER_PUBLIC_IP}
      SERVER_PORT: ${SERVER_PORT_WORLD_1}
      LEVEL_NAME: ${LEVEL_NAME_WORLD_1:-${LEVEL_NAME_COMMON:-Bedrock level}}
      GAMEMODE: ${GAMEMODE_WORLD_1:-${GAMEMODE_COMMON:-creative}}
      DIFFICULTY: ${DIFFICULTY_WORLD_1:-${DIFFICULTY_COMMON:-easy}}
      MAX_PLAYERS: ${MAX_PLAYERS_WORLD_1:-${MAX_PLAYERS_COMMON:-40}}
      ALLOW_COMMANDS: ${ALLOW_COMMANDS_WORLD_1:-${ALLOW_COMMANDS_COMMON:-true}}
      ALLOW_LIST: ${ALLOW_LIST_WORLD_1:-${ALLOW_LIST_COMMON:-false}}
      CHAT_RESTRICTION: ${CHAT_RESTRICTION_WORLD_1:-${CHAT_RESTRICTION_COMMON:-None}}
      VIEW_DISTANCE: ${VIEW_DISTANCE_WORLD_1:-${VIEW_DISTANCE_COMMON:-32}}
      TICK_DISTANCE: ${TICK_DISTANCE_WORLD_1:-${TICK_DISTANCE_COMMON:-4}}
      PLAYER_IDLE_TIMEOUT: ${PLAYER_IDLE_TIMEOUT_WORLD_1:-${PLAYER_IDLE_TIMEOUT_COMMON:-30}}
      MAX_THREADS: ${MAX_THREADS_WORLD_1:-${MAX_THREADS_COMMON:-8}}
      LEVEL_SEED: ${LEVEL_SEED_WORLD_1:-}
      DEFAULT_PLAYER_PERMISSION_LEVEL: ${DEFAULT_PLAYER_PERMISSION_LEVEL_WORLD_1:-${DEFAULT_PLAYER_PERMISSION_LEVEL_COMMON:-member}}
      TEXTUREPACK_REQUIRED: ${TEXTUREPACK_REQUIRED_WORLD_1:-${TEXTUREPACK_REQUIRED_COMMON:-true}}
      CONTENT_LOG_FILE_ENABLED: ${CONTENT_LOG_FILE_ENABLED_WORLD_1:-${CONTENT_LOG_FILE_ENABLED_COMMON:-false}}
      DISABLE_PLAYER_INTERACTION: ${DISABLE_PLAYER_INTERACTION_WORLD_1:-${DISABLE_PLAYER_INTERACTION_COMMON:-false}}
      DISABLE_CUSTOM_SKINS: ${DISABLE_CUSTOM_SKINS_WORLD_1:-${DISABLE_CUSTOM_SKINS_COMMON:-false}}
    volumes:
      # ワールドデータ（worlds/world1/ 配下）
      # worlds/world1に以下のファイル/フォルダが含まれます:
      #   - worlds/          ← ゲームワールドデータ
      #   - behavior_packs/  ← 動作パック（オプション）
      #   - resource_packs/  ← リソースパック（オプション）
      #   - allowlist.json   ← ホワイトリスト
      #   - packetlimitconfig.json ← パケット制限
      #   - server-icon.png  ← サーバーアイコン
      - ${VOLUMES_BASE_PATH:-./}worlds/world1:/minecraft/world-data

      # セッションデータ（sessions/world1/ 配下）
      # IP/ポート変更時には再取得が必要なため別管理
      - ${VOLUMES_BASE_PATH:-./}sessions/world1:/minecraft/sessions

      # ログファイル（logs/world1/ 配下）
      - ${VOLUMES_BASE_PATH:-./}logs/world1:/minecraft/logs

    logging:
      driver: "local"
      options:
        max-size: "50m"    # ファイルが 50MB で自動ローテーション
        max-file: "7"       # 7世代保持（超過分は自動削除）
        compress: "true"    # 自動圧縮

    deploy:
      resources:
        limits:
          memory: 2g
          cpus: "2"

    restart: unless-stopped
    stop_grace_period: 30s   # シャットダウン猶予（ワールド保存完了を待つ）

